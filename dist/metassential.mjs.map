{"version":3,"file":"metassential.mjs","sources":["../src/signer.ts","../src/metaTx.ts","../src/middlewares/nftOwner.ts"],"sourcesContent":["import { Contract } from '@ethersproject/contracts';\nimport { JsonRpcProvider, Web3Provider } from '@ethersproject/providers';\nimport ethSigUtil, { TypedMessage } from '@metamask/eth-sig-util';\nimport { BigNumber } from 'ethers';\nimport { Provider } from '@ethersproject/abstract-provider';\n\nimport ForwardingABI from './abi/Forwarder.json'\n\n/**\n * Field in a User Defined Types\n */\nexport interface EIP712StructField {\n  name: string;\n  type: string;\n}\n\n/**\n * User Defined Types are just an array of the fields they contain\n */\nexport type EIP712Struct = EIP712StructField[];\n/**\n * Interface of the EIP712Domain structure\n */\nexport interface EIP712Domain {\n  name: string;\n  version: string;\n  chainId?: number;\n  verifyingContract: string;\n}\n\n/**\n * Interface of the complete payload required for signing\n */\nexport interface EIP712Payload {\n  types: PayloadTypes;\n  primaryType: string;\n  message: Record<string, string | number>;\n  domain: EIP712Domain;\n}\n\nexport interface EIP712Signature {\n  hex: string;\n  v: number;\n  s: string;\n  r: string;\n}\n\nconst EIP712Domain = [\n  { name: 'name', type: 'string' },\n  { name: 'version', type: 'string' },\n  { name: 'chainId', type: 'uint256' },\n  { name: 'verifyingContract', type: 'address' },\n];\n\nconst ForwardRequest = [\n  { name: 'from', type: 'address' },\n  { name: 'to', type: 'address' },\n  { name: 'value', type: 'uint256' },\n  { name: 'gas', type: 'uint256' },\n  { name: 'nonce', type: 'uint256' },\n  { name: 'data', type: 'bytes' },\n];\n\ninterface PayloadTypes {\n  EIP712Domain: EIP712Struct,\n  ForwardRequest: EIP712Struct,\n}\n\nfunction getMetaTxTypeData(\n  verifyingContract: string,\n  message: Record<string, string | number>,\n  chainId: number,\n  name: string,\n): EIP712Payload {\n  return {\n    types: {\n      EIP712Domain,\n      ForwardRequest,\n    },\n    domain: {\n      name,\n      version: '0.0.1',\n      verifyingContract,\n      chainId,\n    },\n    primaryType: 'ForwardRequest',\n    message,\n  };\n}\n\nasync function signTypedData(\n  signer: Web3Provider | string | Provider,\n  from: string,\n  data: EIP712Payload,\n) {\n  // If signer is a private key, use it to sign\n  if (typeof signer === 'string') {\n    const privateKey = Buffer.from(signer.replace(/^0x/, ''), 'hex');\n    return ethSigUtil.signTypedData({\n      privateKey,\n      data: data as TypedMessage<any>,\n      version: ethSigUtil.SignTypedDataVersion.V4\n    });\n  }\n\n  return await (signer as Web3Provider).send('eth_signTypedData_v4', [from, JSON.stringify(data)]);\n}\n\nasync function attachNonce(\n  forwarder: Contract,\n  input: Record<string, any>,\n): Promise<Record<string, any>> {\n  const nonce = await forwarder\n    .getNonce(input.from)\n    .then((nonce: BigNumber) => nonce.toString());\n  return { value: 0, gas: 1e6, nonce, ...input };\n}\n\nasync function signMetaTxRequest(\n  signer: Web3Provider | Provider,\n  chainId: number,\n  input: Record<string, any>,\n  forwarder: Contract,\n): Promise<{\n  signature: string;\n  request: Record<string, any>;\n}> {\n  \n  const request = await attachNonce(forwarder, input);\n  const toSign = getMetaTxTypeData(forwarder.address, request, chainId, forwarder.name || 'NFightGasStation');\n  const signature = await signTypedData(signer, input.from, toSign);\n\n  return { signature, request };\n}\n\nexport { signMetaTxRequest };\n","import { JsonRpcProvider, Web3Provider } from '@ethersproject/providers';\nimport { Provider } from '@ethersproject/abstract-provider';\nimport { Contract } from '@ethersproject/contracts'\nimport { BigNumber } from 'ethers';\nimport { signMetaTxRequest } from './signer';\n\ntype OwnershipCreds = {\n  contractAddress: string;\n  tokenId: BigNumber;\n};\n\nexport async function sendMetaTx(\n  data: string,\n  to: string,\n  walletProvider: Web3Provider | Provider,\n  network: number,\n  readProvider: JsonRpcProvider,\n  from: string,\n  forwardingContract: Contract,\n  creds?: OwnershipCreds,\n  onSigned?: () => void,\n): Promise<any> {\n  const url = process.env.AUTOTASK_URL;\n\n  const request = await signMetaTxRequest(\n    walletProvider,\n    network,\n    {\n      to,\n      from,\n      data,\n      creds,\n    },\n    forwardingContract,\n  );\n\n  if (!url) throw new Error(`Missing relayer url ${JSON.stringify(request)}`);\n\n  onSigned && onSigned();\n\n  return fetch(url, {\n    method: 'POST',\n    body: JSON.stringify(request),\n    headers: { 'Content-Type': 'application/json' },\n  });\n}\n","\nimport {BigNumber, Contract, utils, providers} from 'ethers';\n\nconst ERC1155 = [\n  'function balanceOf(address _owner, uint256 _id) external view returns (uint256)',\n];\n\nconst ERC721 = [\n  'function ownerOf(uint256 _id) external view returns (address)',\n];\n\n\nasync function ownerOf1155(\n  contractAddress: string,\n  tokenId: string,\n  address: string,\n  mainnetProvider: providers.JsonRpcProvider\n): Promise<boolean> {\n  const nftContract = new Contract(contractAddress, ERC1155, mainnetProvider);\n  const balance = await nftContract.balanceOf(address, BigNumber.from(tokenId));\n\n  return balance.gt(0);\n}\n\nasync function ownerOf721(\n  contractAddress: string,\n  tokenId: string,\n  address: string,\n  mainnetProvider: providers.JsonRpcProvider\n): Promise<boolean> {\n  const nftContract = new Contract(\n    contractAddress,\n    ERC721,\n    mainnetProvider\n  );\n  const owner = await nftContract.ownerOf(BigNumber.from(tokenId));\n\n  return utils.getAddress(owner) === utils.getAddress(address);\n}\n\nasync function isOwner(\n  contractAddress: string,\n  tokenId: string,\n  address: string,\n  mainnetRpcUrl: string\n) {\n  const mainnetProvider = new providers.JsonRpcProvider(mainnetRpcUrl);\n\n  let _isOwner = false;\n\n  try {\n    _isOwner = await ownerOf721(\n      contractAddress,\n      tokenId,\n      address,\n      mainnetProvider\n    );\n  } catch (error) {\n    _isOwner = await ownerOf1155(\n      contractAddress,\n      tokenId,\n      address,\n      mainnetProvider\n    );\n  }\n\n  return _isOwner;\n}\n\nexport {\n  isOwner,\n  ownerOf1155,\n  ownerOf721\n}"],"names":[],"mappings":"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"}